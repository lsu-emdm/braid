<!doctype html>
<html>
<head>

  	<title>BRAID: Web Audio Instruments</title>

	<!-- standard includes of nexusUI and jquery-->
	<link rel="shortcut icon" href="info/images/favicon.png" type="image/png" />
	<script type="text/javascript" src="libraries/jquery.js"></script>
	<script type="text/javascript" src="libraries/jquery-ui-1.8.2.custom.min.js"></script>
	<script type="text/javascript" src="libraries/gibber.lib.js"></script>
	<script type="text/javascript" src="libraries/nexusUI.js"></script>
	<script type="text/javascript" src="libraries/FileSaver.js"></script>
	<script type="text/javascript" src="libraries/qrcode.min.js"></script>

	<link rel="manifest" href="manifest.json">

	<link rel="stylesheet" href="libraries/theme/neo.css">
	<script src="libraries/codemirror.js"></script>
	<link rel="stylesheet" href="libraries/codemirror.css">
	<script src="libraries/mode/javascript/javascript.js"></script>
	<script src="libraries/cm-activeline.js"></script>


	<!-- Make mobile display non-scalable and fitting the viewport window -->
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no, minimal-ui" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />


	<script>

	 	window.AudioContext = window.AudioContext || window.webkitAudioContext;
		var c = new window.AudioContext();

		var globaldragid = false;
		var uicolor = "#0af";
		var freshpage = true;
		var pageName = "bleepbloop";
		var loadInPerformance = false;
		var canvasgridx = 5;
		var canvasgridy = 5;
		var keysdown = new Array();

		var allcode = '';


		nx.onload = function() {

			nx.highlightEditedObj = function() {
			 	$("canvas").css("border", "solid 1px #ccc");
			  	$("canvas").css("z-index", 1);
			  	$("#"+globaldragid).css("border", "solid 1px "+nx.colors.accent);
			  	$("#"+globaldragid).css("z-index", 2);
			}

			nx.WAenv = true;
			if (freshpage) {
				nx.colorize(uicolor);
			}
			nx.showLabels = false;

			//forward all event listeners to execute audio
			for (var key in nx.widgets) {
				with (nx.widgets[key]) {
					on('*', function(data) {
						try {
							audioFunction(data)
						} catch(e) {
							if (!nx.editmode) {
								console.log(e);
								$("#errorbox").html(canvasID+": "+e.message+"    &nbsp;&nbsp; <img src='images/close-icon2.png'>")
								$("#errorbox").css("padding","8px 30px 8px 8px")
							}

						} 
					})
				}
			} 

			if (!nx.globalAudioString) {
				nx.globalAudioString = "";
				newPage(true);
			}

			nx.editOn = function() {
				nx.editmode = true;
			  	$("canvas").css("border", "solid 0px #ccc");
			//  	$("body").css("background", "#eee");
			    $("#locked").attr("src","images/unlocked.png");
			    $("#sidebar").animate({"right": "0px"}, 400);
			    if (IDEon) {
			   		showIDE();
			    }
				$("#mobileguide").css("display","block")
			}

			nx.editOff = function() {
				hideHighlight();
			  	nx.editmode = false;
			  	document.body.style.cursor = "pointer";
			  	$("canvas").css("border", "none");
			//  	$("body").css("background", nx.colors.background);
			    $("#locked").attr("src","images/locked.png");
			    $("#sidebar").animate({"right": "-165px"}, 400);
			    hideIDE();
			    $("#errorbox").html("")
				$("#errorbox").css("padding","0px")
				$("#mobileguide").css("display","none")
				if (nx.isTouchDevice) {
					$("#locked").css("display","none")
				}
				$("#mobileguide").css("display","none")
			}

			if (freshpage) {
				if (window.location.search) {
					loadInPerformance = true;
					var uiname = location.search;
					uiname = uiname.slice(1);
					searchDB(uiname)
					nx.editOff();
				} else {
					//FIXME -- move to nx.onload?
					setTimeout('recallUILocally("lastnxstate")',100)
					if (!nx.isTouchDevice)
					nx.editOn();
				}
				freshpage = false;

				if (nx.isTouchDevice) {
					$("#locked").hide(0)
					nx.editOff()
				}
				

				$(document).mousedown(function(e) {
					if (nx.editmode) {
						var cb = false;
						var e1 = e.srcElement
						for (var i=0;i<14;i++) {
							if (e1) {
								if (e1.id == "L" || e1.id == "R") {
									cb = true;
									break;
								} else {
									e1 = e1.parentNode;
								}
							} else {
								break;
							}
						}

						if (!cb) {
							hideElementCallbackCode();
						}

						if (e.srcElement == $("#nxui")[0]) {
							hideHighlight();
							startHighlighting(e);
						}
					}
				}); 

				$(document).mousemove(function(e) {
					setHighlight(e);
				});

				$(document).mouseup(function() {
					storeUI("lastnxstate");
					document.removeEventListener("mousemove", dragobj, true)
					$("#sidebar").css("opacity",1);
					stopHighlighting();
				});



				$(".editbutton").toggle(function() {
					$(this).html("editing is on")
					nx.editOn();
				}, function() {
					$(this).html("editing is off")
					nx.editOff();
				});

				$("#highlight").draggable({
					drag: function(event,ui) {
						massMove(ui)
					}
				});



				$(document).keydown(function(e){
					console.log(e.keyCode);
					keysdown[e.keyCode] = true
					if (e.keyCode == 69 && keysdown[91]) {
						if (nx.editmode) {
							nx.editOff()
						} else {
							nx.editOn()
						}
					}
				 /*   if (e.keyCode == 8 || e.keyCode == 46 ) {
						e.preventDefault();
			    		nx.widgets[globaldragid] ? nx.widgets[globaldragid].destroy() : null;
			    		for (var i=0;i<highlightList.length;i++) {
			    			highlightList[i].destroy();
				    	}
						hideElementCallbackCode();
						highlightList = new Array();
				    } */
				}) 
				$(document).keyup(function(e){
					keysdown[e.keyCode] = false
				});


				/*
				// for possibly capturing cmd+c later...
				$(document).keydown(function (e) {
				    if (e.metaKey == true) {
				        alert('meta key yo!');
				    }
				}); */
			}

			
		}


		function createObject(data,mousey,mousex) {

				// if it has an nx attribute, store that in nxId
				var nxId = data;
				
				if(nxId) {

					var widget = nx.add(nxId, {
						x: mousex-25,
						y: mousey-25,
						parent: 'nxui' 
					})
					globaldragid = widget.canvasID;
					var thisname = widget.canvasID;
					window[widget.canvasID] = widget;
					showSettings();

				}
				nx.onload();
				document.addEventListener("mousemove", dragobj, true);
				$("#"+thisname).mousemove(function(e) {
					if (nx.editmode && e.pageX>(parseInt(($(this).width()-10))+parseInt($(this).css("left").replace("px",""))) && e.pageY>(parseInt(($(this).height()-10))+parseInt($(this).css("top").replace("px","")))) {
						this.style.cursor = "se-resize"
					} else {
						this.style.cursor = "pointer"
					}
				}) 
			  	nx.highlightEditedObj();
			  	widget.audioString = ""
			  	widget.audioFunction = new Function();
		}


		highlighting = false;
		var hlaxis = new Object();

		function startHighlighting(e) {

			hlaxis = {
				left: e.clientX,
				top: e.clientY
			}

			highlighting = true;
			$("#highlight").css("opacity","0.2");
			$("#highlight").show(0);
			$("#highlight").css("left", e.clientX);
			$("#highlight").css("top", e.clientY);
			$("#highlight").css("width", 0);
			$("#highlight").css("height", 0);

			$("body").css("user-select", "none");
			$("body").css("-moz-user-select", "none");
			$("body").css("-webkit-user-select", "none");
		} 
		function setHighlight(e) {
			if (highlighting) {
				if (e.clientX > hlaxis.left) {
					$("#highlight").css("width", e.clientX-parseInt($("#highlight").css("left")));
				} else if (e.clientX <= hlaxis.left ) {
					$("#highlight").css("width", hlaxis.left - e.clientX + "px");
					$("#highlight").css("left", e.clientX);
				}

				if (e.clientY > hlaxis.top) {
					$("#highlight").css("height", e.clientY-parseInt($("#highlight").css("top")));
				} else if (e.clientY <= hlaxis.top ) {
					$("#highlight").css("height", hlaxis.top - e.clientY + "px");
					$("#highlight").css("top", e.clientY);

				}
				
				
			}
		}
		function stopHighlighting(e) {
			highlighting = false;
			$("#highlight").css("opacity","0.1");
			massHighlight();
		} 
		function hideHighlight(e) {
			$("#highlight").hide(0);
			unhighlightAll();
		}

		var highlightList = new Array();
		var hldata = new Array();

		function massHighlight() {
			var hlDim = {
				left: parseInt($("#highlight").css("left")),
				top: parseInt($("#highlight").css("top")),
				width: parseInt($("#highlight").css("width")),
				height: parseInt($("#highlight").css("height"))
			}
			for (var i in nx.widgets) {
				var widg = nx.widgets[i];
				if ( widg.offset.left>=hlDim.left && widg.offset.top>=hlDim.top && widg.offset.left+widg.width<=hlDim.left+hlDim.width && widg.offset.top+widg.height<=hlDim.top + hlDim.height) {
					widg.hlstart = {
						left: widg.offset.left,
						top: widg.offset.top
					}
					highlightList.push(widg)

				}
			}
		}

		function unhighlightAll() {
			highlightList = new Array();
			//$("canvas").css("border", "solid 1px #ccc");
		}

		function massMove(e) {

			var hlshift = {
				left: e.position.left - e.originalPosition.left,
				top: e.position.top - e.originalPosition.top
			}

			for (var i=0;i<highlightList.length;i++) {
				var widg = highlightList[i];
				widg.canvas.style.left = widg.hlstart.left + hlshift.left + "px";
				widg.canvas.style.top = widg.hlstart.top + hlshift.top + "px";
				widg.offset = nx.findPosition(widg.canvas)
			}

		}

		function dragobj(e) {
			nx.widgets[globaldragid].isBeingDragged = true;
			nx.widgets[globaldragid].preMove(e);
		
		}



		function showSettings() {
			if (globaldragid) {
				$("#oscpath").attr("value", nx.widgets[globaldragid].oscName);
			}
		}

		function deleteObject() {
			nx.widgets[globaldragid] ? nx.widgets[globaldragid].destroy() : null;
    		for (var i=0;i<highlightList.length;i++) {
    			highlightList[i].destroy();
	    	}
			hideElementCallbackCode();
			highlightList = new Array();
		}

		function setoscname(val) {
			nx.widgets[globaldragid].oscName = val;
			nx.widgets[globaldragid].draw();
		}

		function changeip(val) {
			nx.oscIp = val;
		}

		function blockMove(e) {
       		e.preventDefault();
		}

		function setcursor(e) {
		}
		
		function saveUI() {

		 	var html = '<!doctype html>\n'
	    	+ '<html>   \n'
			+ '<head>   \n'
			+ '<title>NexusDrop</title>\n' 
			+ '<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\n'
			+ '<meta name="viewport" content="initial-scale=0.5, user-scalable=no"/>\n'
			+ '<script type="text/javascript" src="jquery.js"><\/script>\n'
			+ '<script type="text/javascript" src="nexusUI.js"><\/script>\n'
			+ '</head>\n'                
			+ '<body>\n'                
			+ '<script>\n'
			+ 'nx.onload = function() {\n'
			+ '	nx.colorize("'+uicolor+'");\n'
			+ '	nx.sendsTo("ajax");\n'
			+ '	nx.usesScript("nexusOSCRelay.php");\n'
			+ '}\n'
			+ '<\/script>\n';

			for (var i in nx.widgets) {
				var thisobj = document.getElementById(nx.widgets[i].canvasID);
				var thisosc = nx.widgets[i].oscName;
				thisosc = thisosc.replace("/","")
				html += '<canvas id="'+thisosc+'" nx="'+thisobj.getAttribute("nx")+'" style="position:absolute;top:'+thisobj.style.top+';left:'+thisobj.style.left+';height:'+nx.widgets[i].height+'px;width:'+nx.widgets[i].width+'px"></canvas>\n'
			}

			html += '</body>\n'
			+ '</html>\n';


			var blob = new Blob([html], {type: "text/html;charset=utf-8"});
			saveAs(blob, "nexusdrop.html");
			
		}



		// mobile specific stuff

		function perform() {
			if (!nx.editmode) {
				//turn editing on
				$("#perfbutt").html("unlocked")
			//	$("#perfbutt").css("background-color","#ddd")
				$("#addbutt").show(0);
				$("#editbutt").show(0);
				nx.editOn();
			//	nx.setLabels("on")
			} else {
				$("#perfbutt").html("locked")
				$("#addbutt").hide(0);
				$("#editbutt").hide(0);
			//	$("#perfbutt").css("background-color","#9df")
				nx.editOff();
			//	nx.setLabels("off")
			}

		}

		function storeUI(uiname) {
			localStorage[uiname] = makeUIjson();

		}

		function makeUIjson() {
			var jsonui = {
				"globalAudio": nx.globalAudioString,
				"elements": new Array(),
				"settings": {
					"colors": nx.colors,
					"votes": 0,
					"timestamp": new Date()
				}
			}

			for (var i in nx.widgets) {

				if (nx.widgets[i]) {
					var objsettings = nx.widgets[i].settings ? nx.widgets[i].settings : "";
				}

				var thistype = nx.widgets[i].canvasID;
				thistype = thistype.replace(/[0-9]/g, '');
				
				jsonui.elements.push({
					type: thistype,
					canvasID: nx.widgets[i].canvasID,
					oscName: nx.widgets[i].oscName,
					width: nx.widgets[i].width,
					height: nx.widgets[i].height,
					"top": nx.widgets[i].offset.top,
					"left": nx.widgets[i].offset.left,
					"audioString": nx.widgets[i].audioString,
					"settings": objsettings
				})
			}
			return JSON.stringify(jsonui);
		}



		function recallUILocally(uiname) {
		//	if (JSON.parse(uijson)localStorage[uiname]) {
		//		console.log(localStorage[uiname])
				if (localStorage[uiname]!=undefined) {
					buildUIfromJSON(localStorage[uiname])
				}
				
		//	}
		}

		function buildUIfromJSON(uijson) {

			var nxui = JSON.parse(uijson)

			$("#nxui").html("");
			nx.widgets = new Object();
			nx.elemTypeArr = new Array();

			// audio

			//check for global audio property
			if (nxui.globalAudio) {
				nx.globalAudioString = nxui.globalAudio;
			} else {
				nx.globalAudioString = defaultglobalaudio;
			}
			showGlobalAudioCode();

			if (nxui.settings) {
				renderSettings(nxui.settings);
			}
			

			//check for elements property, and overwrite nxui with just the elements
			if (nxui.elements) {
				nxui = nxui.elements;
			}
			//otherwise assume list is only elements

			for (var i=0;i<nxui.length;i++) {

				// if it has an nx attribute, store that in nxId
				var nxId = nxui[i].type;
				var thisname = nxui[i].canvasID;
				thisname = thisname.replace("/","");
				if(nxId) {

					var widget = nx.add(nxId, {
						x: nxui[i].left,
						y: nxui[i].top,
						w: nxui[i].width,
						h: nxui[i].height,
						name: thisname,
						parent: 'nxui' 
					})

					window[widget.canvasID] = widget;

					nx.widgets[thisname].oscName = nxui[i].oscName;
					globaldragid = thisname;
					$("#"+thisname).mousemove(function(e) {
						if (nx.editmode && e.pageX>(parseInt(($(this).width()-20))+parseInt($(this).css("left").replace("px",""))) && e.pageY>(parseInt(($(this).height()-20))+parseInt($(this).css("top").replace("px","")))) {
							this.style.cursor = "se-resize";
						} else {
							this.style.cursor = "pointer";
						}
					}) 
					widget.audioString = nxui[i].audioString;
					widget.audioFunction = new Function("data", nxui[i].audioString);
				}
			}
			nx.onload();
			showSettings();
			$("#edit").hide(0);
			$("canvas").css("border", "solid 0px #ccc");

			if (loadInPerformance) {
				updateGlobalAudio();
				loadInPerformance = false;
			}
		}

		function renderSettings(settings) {
			if (settings.colors) {
				nx.colors = settings.colors;
				$('body').css('background-color', settings.colors.background)
				$('#accentcolor').attr('value',settings.colors.accent)
				$('#fillcolor').attr('value',settings.colors.fill)
				$('#bordercolor').attr('value',settings.colors.border)
				$('#whitecolor').attr('value',settings.colors.white)
				$('#blackcolor').attr('value',settings.colors.black)
				$('#bgcolor').attr('value',settings.colors.background)

			}
		}



		function changeColor(newcolor) {
			uicolor = newcolor;
			nx.colorize(newcolor);
		}




		/**** COMMUNICATE WITH DB ****/


		function askToSaveToDB() {
			var uiname = prompt("Please name your interface", pageName);
			var overwriting = false;
			if (uiname) {

				for (var i=0;i<UIDB.length;i++) {
	        		if (UIDB[i].name) {
		        		if (UIDB[i].name.toLowerCase() == uiname.toLowerCase()) {
		           			currentUI = UIDB[i];
		           			overwriting = true;
		           			break;
		           		}
		           	}
	        	}

	        	if (overwriting) {

					var confirmoverwrite = confirm("Are you sure you want to overwrite the interface:" + currentUI.name);

		        	if (!confirmoverwrite) { return }

					updateToDB(uiname)

				} else {

					saveToDB(uiname);

	        	}
	        	
			}
			
		}

		function saveToDB(name) {
			
			setPageName(name);

		//	clearSearchbar();

			var mydata = {
				"nexus_ui": {
					"name": name,
					"transmission": "test",
					"uiJSON": makeUIjson()
				}
			}
			
			mydata = JSON.stringify(mydata);

			hideSearchbar()

			jQuery.ajax({
			    type: "POST",
			    url: "http://nexus.cct.lsu.edu:8000/nexus_uis",
			    data: mydata,
			    crossDomain: true,
  				dataType: 'json',
			    contentType: "application/json",
			    success: function(){
			        loadDB(setUIDB);
			    },
			    failure: function(errorMsg) {
			        console.log(errorMsg);
			    }
			}); 


		}


		function updateToDB(name) {
			
			setPageName(name);

			var mydata = {
				"nexus_ui": {
					"name": name,
					"transmission": "test",
					"uiJSON": makeUIjson()
				}
			}
			
			mydata = JSON.stringify(mydata);

			hideSearchbar()

			jQuery.ajax({
			    type: "PUT",
			    url: currentUI.url,
			    data: mydata,
			    crossDomain: true,
  				dataType: 'json',
			    contentType: "application/json",
			    success: function(){
			        loadDB(setUIDB);
			    },
			    failure: function(errorMsg) {
			        console.log(errorMsg);
			    }
			}); 


		}



		var UItoLoad;

		function searchDB(name) {

			UItoLoad = name;
			setPageName(name);

			loadDB(function (data) {
				setUIDB(data)
	        	for (var i=0;i<data.length;i++) {
	        		if (data[i].name) {
		        		if (data[i].name.toLowerCase() == UItoLoad.toLowerCase()) {


		           			buildUIfromJSON(data[i].uiJSON);
		           			currentUI = data[i];
							clearGlobalAudio();
		           			return;
		           		}
		           	}
	        	}
	        	alert("Could not find the UI: "+UItoLoad);
		    })
		}

		var UIDB;

		function loadDB(callback) {

			$.ajax({
				type: "GET",
			    url: "http://nexus.cct.lsu.edu:8000/nexus_uis.json",
			    crossDomain: true,
  				dataType: 'json',
			    contentType: "application/json",
		        success: function(data) {
		        	callback(data);
			        for (var i=0;i<data.length;i++) {
		        		if (data[i].name) {
			        		if (data[i].name.toLowerCase() == pageName.toLowerCase()) {
			           			currentUI = data[i];
			           			return;
			           		}
			           	}
		        	}
		        },
		        error: function(err) {
		        	console.log(err)
		        }
			})

		}

		loadDB(setUIDB);

		function setUIDB(data) {
			UIDB = data;
			showSearchbar()
		}

		function sortDB(name) {
			var options = "";
			if (name.length>0) {
			    for(var i = 0; i < UIDB.length; i++) {
			    	dbname = UIDB[i].name
			    	if (dbname) {
				    	if (dbname.substring(0,name.length).toLowerCase()==name.toLowerCase()) {
				    		options += '<a class="dbopt" href="javascript:searchDB(\''+UIDB[i].name+'\')">'+UIDB[i].name+'</a> ';
				    	}
				    }
			    }
			}
		    document.getElementById('searchresults').innerHTML = options;

		}

		var currentUI = false;

		function deleteFromDB() {
			if (confirm("Are you sure you want to delete "+pageName+"?")) {

				hideSearchbar()

				if (currentUI) {
					$.ajax({
				        url: currentUI.url,
				        type: 'DELETE',
				        crossDomain: true,
		  				dataType: 'json',
					    contentType: "application/json",
				        success: function(data) {
				        	loadDB(setUIDB);
				        },
				        error: function(err) {
				        	console.log(err)
				        }
				    });

				} else {
					showSearchbar()
				}

				newPage();


			}
		}



		function hideSearchbar() {
			$("#loadsection").hide(0)
			$("#loadsection_loading").show(0)
			clearSearchbar()
		}
		function showSearchbar() {
			$("#loadsection").show(0)
			$("#loadsection_loading").hide(0)
		}
		function clearSearchbar() {
			$("#searchresults").html("");
			$("#searchdb").val("")
		}





		/* inline coding */

		function saveCallback() {
			var callback = callbackeditor.getValue()
			nx.widgets[globaldragid].audioString = callback.toString();

			try {
				$("#roamingcode .title").css("background-color","#ccc");
				var cb 
				nx.widgets[globaldragid].audioFunction = new Function("data", callback.toString());
			} catch(e) {
				$("#roamingcode .title").css("background-color","#f00");

			} 
		}

		function saveGlobalAudio() {
			var ga = globaleditor.getValue()
			nx.globalAudioString = ga.toString();
		}


		function showGlobalAudioCode() {
			//$("#guiglobalaudio").setValue(nx.globalAudioString);
			globaleditor.setValue(nx.globalAudioString)

		/*	//To focus the ace editor
		//	var session = globaleditor.getSession();
			//Get the number of lines
		//	var count = session.getLength();
			//Go to end of the last line
		//	globaleditor.gotoLine(count, session.getLine(count-1).length);
			*/
            	
		}

		var cbleft;

		function showElementCallbackCode(element) {


			callbackeditor.setValue(element.audioString)

			var al = document.getElementById("arrow-left")
			var ar = document.getElementById("arrow-right")
			$("#roamingcode").css("top", element.offset.top + "px");
			if (element.offset.left <= window.innerWidth/2) {
				$("#roamingcode").css("left", element.offset.left + element.width + 3 + "px");
				$("#R").css("right","auto");
				$("#R").css("left","14px");
				al.style.display = "block";
				ar.style.display = "none";
				cbleft = true;
			} else {
				$("#roamingcode").css("left", element.offset.left - $("#roamingcode").width() + "px");
				$("#R").css("right","14px");
				$("#R").css("left","auto");
				ar.style.display = "block";
				al.style.display = "none";
				cbleft = false;
			}


         	$('#roamingcode').show(0)

			callbackeditor.focus();
			callbackeditor.setCursor(500)

          

			$("#perelement").html(element.canvasID);
			var dataprops = " &nbsp;&nbsp;";
			for (var key in element.val) {
				dataprops += "data."+key+" &nbsp;"
			}
			if (dataprops.length >=100) { dataprops = dataprops.substring(0,100) + " ... "}
			$("#dataprops").html(dataprops);



		}

		function hideElementCallbackCode() {
			$("#roamingcode").css('top','-500px');
		}

		/* global */

		function updateGlobalAudio() {
			renderAudio();
		/*	if (Gibber.started) {
				Gibber.clear(renderAudio);
			//	setTimeout(renderAudio, 2000);
				console.log("started")
			} else {
				renderAudio();
				console.log("notstarted")
			} */
		//	setTimeout(renderAudio, 1000);
		}

		function clearGlobalAudio() {
			Gibber.clear();
		}

		function renderAudio() {
		////	nx.globalAudioString = globaleditor.getValue();

			$.globalEval(nx.globalAudioString);
			Gibber.started = true;
		}


		/* new page */

		function newPage(justloaded) {
			currentUI = false;
			nx.widgets = new Object();
			nx.elemTypeArr = new Array();
			$("#nxui").html("");
			nx.globalAudioString = defaultglobalaudio;
			showGlobalAudioCode();
			updateGlobalAudio()
			setPageName("Untitled")
			nx.colors.background = "#DDDDDD"
			if (!justloaded) {
			//	clearGlobalAudio();
			} else {
				nx.globalAudioString = defaultglobalaudio;
			}
		}

		var defaultglobalaudio = "\n// Welcome to Nexus's web audio environment!\n// AudioContext is initialized as variable c \n\n";

		var IDEon = true;

		function toggleIDE() {
			if (IDEon) {
				IDEon = false;
				hideIDE();
			//	nx.sendsTo("ajax");
			} else {
				IDEon = true;
				showIDE();
			//	nx.sendsTo("js");
			}
		}

		function showIDE() {
			$("#codingarea").animate({"bottom": "0px"}, 400);
		}

		function hideIDE() {
			$("#codingarea").animate({"bottom": "-250px"}, 400);
		}

		function setPageName(name) {
			pageName = name;
			$("#title").val(name);
		}

		function makeWidget(title,e) {
			$("#sidebar").css("opacity",0.6);
			document.body.style.userSelect = "none";
			document.body.style.mozUserSelect = "none";
			document.body.style.webkitUserSelect = "none";
			createObject(title,e.pageY,e.pageX);

		}


		var fullIDE = false;
		function toggleFullIDE() {
			if (!fullIDE) {
				$("#codingarea").addClass('fullIDE')
				fullIDE = true;
			//	showAllCode();
			} else {
				$("#codingarea").removeClass('fullIDE')
				fullIDE = false;
			//	hideAllCode();
			}
		}

		function toggleFullCallback() {
			if (!fullIDE) {
				$("#roamingcode").addClass('fullIDE')

				$("#R").css("left","0px")
				$("#R").css("right","0px")
				fullIDE = true;
			} else {
				$("#roamingcode").removeClass('fullIDE')
				if (cbleft) {
					$("#R").css("left","14px")
					$("#R").css("right","auto");
				} else {	
					$("#R").css("left","auto")
					$("#R").css("right","14px");
				}
				fullIDE = false;
			}
		}

		function showAllCode() {
			var ga = globaleditor.getValue()
			nx.globalAudioString = ga.toString();

			allcode = nx.globalAudioString;

			allcode += '\n\n\n\n/*******************\n'
			allcode += '* WIDGET CALLBACKS *\n'
			allcode += '*******************/\n';

			var sortedkeys = keys(nx.widgets).sort();

			for (var i=0;i<sortedkeys.length;i++) {
				var key = sortedkeys[i];
				var id = nx.widgets[key].canvasID
				allcode += '\n\n\n\n/******** '+id.toUpperCase()+' ********/ \n\n';
				allcode += nx.widgets[key].audioString;
			}

			globaleditor.setValue(allcode);
		}

		function hideAllCode() {
			var shortcode = nx.globalAudioString
			shortcode = shortcode.substring(0,shortcode.indexOf('\n\n\n\n/*******************')-1);
			nx.globalAudioString = shortcode;
			globaleditor.setValue(nx.globalAudioString);
		}

		//sorts keys alphabetically
		function keys(obj)
		{
		    var keys = [];

		    for(var key in obj)
		    {
		        if(obj.hasOwnProperty(key))
		        {
		            keys.push(key);
		        }
		    }

		    return keys;
		}

		var infowin;
		function infoWindow() {
			var type = nx.widgets[globaldragid].canvasID;
			type = type.replace(/[0-9]/g, '');
			var dw = nx.widgets[globaldragid].defaultSize.width;
			dw += 600;
			var dh = nx.widgets[globaldragid].defaultSize.height;
			dh = nx.clip(dh,250,600)
			infowin = window.open("infowin.html?"+type, "infowin", "toolbar=no, scrollbars=no, resizable=no, top=0, left=0, width="+dw+", height="+dh);
			infowin.focus();
		}


		var devices = {
			"phone_landscape": {
				name: "Avg Phone (Landscape)",
				width: 568,
				height: 320
			},
			"phone_portrait": {
				name: "Avg Phone (Portrait)",
				width: 320,
				height: 568
			},
			"tablet_landscape": {
				name: "Avg Tablet (Landscape)",
				width: 1024,
				height: 768
			},
			"tablet_portrait": {
				name: "Avg Tablet (Portrait)",
				width: 768,
				height: 1024
			},

		}
		function setGuide(key) {
			var guide = devices[key]
			$("#mobileguide").css("width", guide.width)
			$("#mobileguide").css("height", guide.height)
			$("#mobileguide #tip").html(guide.name)
		}


	</script>
</head>
<body>
	<style>

		body {
			margin:0px;
			padding:0px;
			width:100%;
			height:100%;
			background-color:#ddd;
		}

		.butt {
			text-align:center;
			width:45%;
			box-sizing:border-box;
			padding:10px 10px;
			margin:20px auto;
			border:solid 1px #ccc;
			font-size:12pt;
			background-color:#ddd;
		}

		.nxbutt {
			float:left;
			text-align:center;
			width:45%;
			box-sizing:border-box;
			padding:10px 10px;
			margin:10px 2%;
			border:solid 1px #ccc;
			font-size:12pt;
			background-color:#ddd;
		}

		body, input, button {
			font-family:helvetica;
			font-size: 12pt;
			font-weight:100;
			user-select:none;
			-moz-user-select:none;
			-webkit-user-select:none;
		}

		#addnew {
			display:none;
			width:70px;
			height:40px;
			float:left;
		}

		.overlay {
			position:fixed;
			left:0px;
			top:0px;
			width:100%;
			height:100%;
			box-sizing:border-box;
			background-color:#eee;
			display:none;
			overflow:auto;
			z-index:100;
		}

		/* new */

		/* ui page */

		#nxui {
			position:absolute;
			width:100%;
			height:100%;
		}

		/* sidebar */

		#sidebar {
			position:fixed;
			top:0px;
			right:-165px;
			height:100%;
			background-color:#fafafa;
			border-right:solid 1px #ccc;
			width:165px;
			z-index:3;

		}

		#sidebar input {
			padding:4px 10px;
			box-sizing:border-box;
			outline:solid 0px;
		}

		#sidebar #titleimg {
			width:100%;
			font-size:11px;
			border:none;
			font-weight:normal;
			color:#ccc;
			padding:5px 10px 2px;
			letter-spacing:1px;
		}

		#sidebar #titleimg img {
			width:15px;
			opacity:0.7;
		}

		#sidebar #title {
			width:100%;
			font-size:12px;
			border:none;
			font-weight:normal;
			color:#999;
			padding:6px 10px;
			letter-spacing:1px;
		}

		#sidebar .header {
			width:100%;
			padding:5px 10px;
			font-size:13px;
			color:#333;
			box-sizing:border-box;
			background-color:#e3e3e3;
		}

		#searchdb:focus, #oscpath:focus {
			outline:solid 1px #444;
		}

		#searchdb, #oscpath {
			color:#555;
			font-size:13px;
			margin:3px;
			display:block;
			box-sizing:border-box;
			width:159px;
		}

		#elemlist {
			height:100%;
			width:100%;
			overflow:auto;
		}

		.nxopt {
			padding:4px 10px;
			font-size:14px;
			color:#444;
			border:solid 1px #eee;
		}

		#footer {
			position:absolute;
			bottom:0px;
			display:block;
			width:100%;
			background-color:#f7f7f7;
		}

		#oscpath {
			width:120px;
			float:left;
		}

		#elemtrash, #savetodb, #dbtrash, #moreoptions, #newpage {
			opacity:0.7;
			margin-left:5px;
			cursor:pointer;
			height:20px;
		}

		#elemtrash, #locked {
			opacity:0.7;
			margin-left:5px;
			cursor:pointer;
			height:30px;
		}

		#savetodb, #dbtrash, #moreoptions, #locked, #newpage {
			margin-top:3px;
			margin-bottom:3px;
		}



		#savetodb {
			margin-left:10px;
		}

		#locked {
			position:absolute;
			right:170px;
			bottom:5px;
		}

		.dbopt {
			font-size:13px;
			color:#048;
			margin:2px 0px 2px 10px;
			line-height:25px;
		}

		input {   
		    -webkit-user-select: text;
		    -khtml-user-select: text;
		    -moz-user-select: text;
		    -ms-user-select: text;
		    user-select: text;
		
		}


	</style>


	<div id="mobileguide" style="width:568px;height:320px;border:dashed 1px #fff;position:absolute;top:0px;left:0px;">
		<div id="tip" style="background-color:#eee;font-size:8pt;font-family:gill sans;color:#bbb;top:0px;right:0px;padding:3px;position:absolute;">iPhone 5</div>
	</div>

	<div id="nxui"></div>
	

	<div id="sidebar">

		<div class="header">
			<a style="text-decoration:none;font-weight:bold;font-size:9pt;color:#888" href="info/">BRAID</a>
			<a style="position:absolute;right:15px;top:5px;color:#0af;text-decoration:none;" href="info/">info</a>
		</div>

		<input id="title" type="text" value="Untitled"></input>



		<!--	<div class="header">
				Interface
			</div> -->

			<img src="images/newpage.png" id="newpage" onclick="newPage()" style="margin-left:10px;opacity:0.5">
			<img src="images/disk.png" id="savetodb" onclick="askToSaveToDB()">
			<img src="images/trash.png" id="dbtrash" onclick="deleteFromDB()">
		<!--	<img src="images/more.png" id="moreoptions" onclick="openEdit()"> -->
	<!--		<span style="font-size:30px;color:#aaa;font-family:trebuchet ms;margin-top:5px;margin-left:10px;float:left" onclick="toggleIDE()">&lt;&gt;</span> -->


			<div style="display:inline;height:20px;float:right;padding-right:15px">
	
				<a href="javascript:openQR()" style="color:#c3c3c3;line-height:30px;font-size:17px;text-decoration:none;font-weight:bold">QR</a>

			</div>

			<div id="colorcontrols">
				<input type="color" value="#00aaff" id="accentcolor" name="accentcolor" oninput="nx.colorize(this.value);nx.colors.accent=this.value" title="Accent Color">
				<input type="color" value="#cccccc" id="bordercolor" name="bordercolor" oninput="nx.colorize('border',this.value)" title="Border Color">
				<input type="color" value="#f7f7f7" id="fillcolor" name="fillcolor" oninput="nx.colorize('fill',this.value)" title="Fill Color">
				<input type="color" value="#000000" id="blackcolor" name="blackcolor" oninput="nx.colorize('black',this.value)"  title="Black Aspects">
				<input type="color" value="#ffffff" id="whitecolor" name="whitecolor" oninput="nx.colorize('white',this.value)"  title="White Aspects">
				<input type="color" value="#ffffff" id="bgcolor" name="bgcolor" oninput="$('body').css('background-color',this.value);nx.colors.background=this.value" title="Background Color">
			</div>

			<style>

			#colorcontrols {

				padding:3px 10px;
				background-color:#f3f3f3;
			}
			#colorcontrols input {
				width:20px;
				height:20px;
				margin:3px 0px;
				padding:1px;
				left:0px;
			}
			</style>

			<select style="height:25px;width:100px;font-size:8pt;border:solid 0px;padding:1px 10px" onchange="setGuide(this.value)">
				<option value="phone_landscape">Phone (Landscape)</option>
				<option value="phone_portrait">Phone (Portrait)</option>
				<option value="tablet_landscape">Tablet (Landscape)</option>
				<option value="tablet_portrait">Tablet (Portrait)</option>
			</select>
			<!-- setGuide -->

		<script>

				function openQR() {
					qrcode.makeCode("http://www.nexusosc.com/drop/braid/?"+pageName)
					$("#qrtitle").html(pageName);
					$("#qrcode_overlay").fadeIn(500);
				}
				
				

/*
			function openQR() {
				var output = '<html><head><script type="text/javascript" src="libraries/qrcode.min.js"><\/script></head><body><div style="font-family:gill sans;color:#888;padding:20px">This is a QR Code to the <b>last saved or loaded interface</b> in your browser. If you have not recently saved your interface, do so now.</div><div id="qrcode" style="width:275px;margin:0 auto"></div><script>var qrcode = new QRCode(document.getElementById("qrcode"), "http://nexusosc.com/drop/braid/");<\/script></body></html>';
				window.open("name","http://www.tester.com","width=320,height=400").document.write(output);
			} */
		</script>

		<div class="header">
			Load
		</div>

		<div id="loadsection">

		<input id="searchdb" name="searchdb" type="text" placeholder="Search UI Database" onkeyup="if (event.keyCode == 13) {searchDB(this.value)} else {sortDB(this.value)}">
		</input>

		<div id="searchresults"></div>

		</div>


		<div id="loadsection_loading" style="display:none;width:100%;">

			<img src="images/loading.gif" style="width:20px;margin:15px auto;display:block">

		</div>


		<div class="header">
			Add
		</div>

		<style>

			.nxoptimg {
				float:left;
				width:35px;
				height:35px;
				margin:0px 0px 0px 0px;
				padding:9px 10px 9px 9px;
				//border-radius:3px;
				//-webkit-border-radius:3px;
				border:solid 1px #f7f7f7;
				border-left:solid 0px;
				border-top:solid 0px;
			}

		</style>

		<div id="elemlist" style="background-color:white;padding-left:1px;">

			<script>

			var elembuttons = [ "button", "dial", "toggle", "slider", "position", "range", "number", "keyboard", "tilt", "multislider", "multitouch", "envelope", "matrix", "mouse", "typewriter", "string", "colors", "metro", "vinyl", "joints", "remix", "banner" ]
			                     

			for (var i=0;i<elembuttons.length;i++) {
				var htmlstr = '<img class="nxoptimg" title="'+elembuttons[i]+'" draggable="false" src="images/'+elembuttons[i]+'.png" onmousedown="makeWidget(this.title,event)">'
				document.write(htmlstr);
			}
			document.write('<div style="clear:both"></div>');

			</script>

			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
			<br>
		</div>




		<div id="footer">

			<div class="header">
				Element
			</div>

			<input id="oscpath" type="text" placeholder="/OSCpath" onkeyup="setoscname(this.value)"></input>
			<img src="images/trash.png" id="elemtrash" onclick="deleteObject()">
			<div style="clear:both"></div>



			<img src="images/unlocked.png" id="locked" onclick="perform()">


		</div>

	</div>



	<div id="codingarea">
		<div id="L">
			<div class="title">
				global js
				<img src="images/fullscreen.png" onclick="toggleFullIDE()" style="height:15px;width:15px;right:2px;margin-top:0px;opacity:0.6;position:absolute">
			</div>
			<div id="guiglobalaudio"></div>
			<button id="updateGlobalAudio" onclick="updateGlobalAudio()">Run</button>
			<button id="clearGlobalAudio" onclick="clearGlobalAudio()">Reset</button>
			
		</div>
	</div>


	<div id="roamingcode">
		<div id="arrow-left"></div>
		<div id="arrow-right"></div>
		<div id="R">
			<div class="title">
				<span id="perelement"></span>
				:
				<span id="dataprops"></span>
				<img src="images/infowin.png" onclick="infoWindow()" style="height:22px;width:22px;right:25px;margin-top:-3px;opacity:0.9;position:absolute">
				<img src="images/fullscreen.png" onclick="toggleFullCallback()" style="height:15px;width:15px;right:8px;margin-top:0px;opacity:0.6;position:absolute">
			</div>
			<div id="guicallback" onkeyup="saveCallback(this.value)"></div>
		</div>
	</div>


<script>
/*var globaleditor = ace.edit("guiglobalaudio");
globaleditor.setTheme("ace/theme/monokai");
globaleditor.getSession().setMode("ace/mode/javascript");
globaleditor.on("change", saveGlobalAudio)
var callbackeditor = ace.edit("guicallback");
callbackeditor.setTheme("ace/theme/monokai");
callbackeditor.getSession().setMode("ace/mode/javascript");
callbackeditor.on("change", saveCallback)*/
</script>



<script>

var globaleditor = CodeMirror(document.getElementById('guiglobalaudio'), {
  value: "function myScript(){return 100;}\n",
  mode:  "javascript",
  styleActiveLine: "true",
  lineNumbers:true,
  theme: 'neo'
});

var callbackeditor = CodeMirror(document.getElementById('guicallback'), {
  value: "function myScript(){return 100;}\n",
  mode:  "javascript",
  styleActiveLine: "true",
  lineNumbers:"true",
  theme: 'neo'
});

globaleditor.on('change', saveGlobalAudio)
callbackeditor.on('change', saveCallback)


</script>


	<style> 

		#codingarea {
			position:fixed;
			margin:0px;
			padding:0px;
			bottom:-300px;
			left:0px;
			height:250px;
			width:600px;
			display:block;
			box-sizing:border-box;
			padding-right:0px;
			z-index:2;
			opacity:0.9;
		}

		.fullIDE {
			top: 0px !important;
			left: 0px !important;
			width: 100% !important;
			height: 100% !important;
			z-index: 1000 !important;
			margin: 0;
			padding: 0;
			opacity: 1 !important;
			position:fixed !important;
		}

		#codingarea #L {
			width:100%;
			height:100%;
			float:left;
			background-color:#ddd;
			position:relative;
		} 

		#R {
			top:0px;
			left:14px;
			width:100%;
			height:100%;
			background-color:#ddd;
			position:absolute;
			border-radius:10px;
			-webkit-border-radius:10px;
			-moz-border-radius:10px;
			overflow:hidden;
		}

		#roamingcode {
			position:absolute;
			display:none;
			top:0px;
			left:0px;
			z-index:10;
			width:430px;
			height:150px;
			opacity:0.9;
		}

		#codingarea #L .title, #R .title {
			color:#333;
			font-weight:bold;
			font-size:12px;
			padding:3px 10px;
		}

		#codingarea #L .title img:hover {
			opacity:1 !important;
		}

		#guicallback, #guiglobalaudio {
			width:100%;
			height:90%;
			outline:none;
			font-size:10pt;
			border:none;
			/*border-left:solid 1px #ccc;*/
			background-color:#fff;
			box-sizing:border-box;
			padding:0px;
			font-family:lucida console, courier, sans-serif;
			font-weight:100;
			color:#eee;
			position:absolute;
		}
		#guicallback:focus, #guiglobalaudio:focus {
		/*	outline:solid 1px #444; */
			background-color:#fff;
		}

		#updateGlobalAudio, #clearGlobalAudio {
			position:absolute;
			bottom:3px;
			right:70px;
			background-color:#ddd;
			color:#333;
			border:solid 1px #ccc;
			font-size:9pt;
			padding:4px 12px;
			outline:none;
			cursor:pointer;
			z-index:50;
		}
		 #clearGlobalAudio {
		 	right:3px;
		 }

		
		#updateGlobalAudio:hover, #clearGlobalAudio:hover {
			background-color:#bbb;
		}

		#perelement {
			color:#000;
		}

		#arrow-left {
			position:absolute;
			left:0px;
			top:20px;
			width: 0; 
			height: 0; 
			border-top: 15px solid transparent;
			border-bottom: 15px solid transparent; 
			border-right:15px solid #fff; 
		}

		#arrow-right {
			display:none;
			position:absolute;
			right:0px;
			top:20px;
			width: 0; 
			height: 0; 
			border-top: 16px solid transparent;
			border-bottom: 16px solid transparent;	
			border-left: 16px solid #fff;
		}

		.ace_gutter {
			width:20px;
		}



		#highlight {
			border:solid 1px #08b;
			background-color:#0af;
			opacity:0.2;
			width:100px;
			height:100px;
			position:absolute;
			z-index:20;
			display:none;
		}

		</style>


		<div id="highlight"></div>


		<div id="qrcode_overlay" onclick="$('#qrcode_overlay').fadeOut(200)" style="display:none;width:100%;height:100%;position:fixed;top:0px;left:0px;background-color:#f7f7f7;z-index:10">


			<div id="qrcode" style="width:275px;margin:40px auto 20px"></div>


			<div style="font-family:gill sans;color:#888;width:450px;margin:20px auto;font-size:18px;text-align:left;line-height:22px;">http://nexusosc.com/drop/braid?<span style="font-weight:bold" id="qrtitle" ></span></div>


			<div style="font-family:gill sans;color:#888;width:450px;margin:20px auto;font-size:18px;text-align:justify;line-height:22px"> 
				This is a QR Code to your last saved or loaded interface. If you have not recently saved your interface, do so now and generate a new QR code.
			</div>

			<script>
				var qrcode = new QRCode(document.getElementById("qrcode"), "http://nexusosc.com/drop/braid/");



 				Gibber.init();

			</script>



		</div>


		<div id="errorbox" onclick="this.innerHTML='',this.style.padding='0px'"></div>


		<style>

			#errorbox {
				position:fixed;
				bottom:0px;
				left:0px;
				background-color:#f44;
				font-size:10pt;
				color:white;
				z-index:100;
				opacity:1;
				font-weight:bold;
				max-width:50%;
			}

			#errorbox img {
				position: absolute;
				right: 5px;
				top: 5px;
			}

		</style>




</body>	
</html>
